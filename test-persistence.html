<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据持久化测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        .test-result {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>数据持久化功能测试</h1>
    
    <div class="test-section">
        <h2>1. 检查localStorage状态</h2>
        <button onclick="checkLocalStorage()">检查localStorage</button>
        <div id="localStorageStatus" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 模拟用户登录</h2>
        <button onclick="simulateLogin()">模拟登录用户test</button>
        <button onclick="simulateLogin2()">模拟登录用户test2</button>
        <div id="loginStatus" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 模拟数据操作</h2>
        <button onclick="addTestData()">添加测试数据</button>
        <button onclick="modifyTestData()">修改测试数据</button>
        <button onclick="deleteTestData()">删除测试数据</button>
        <div id="dataOperationStatus" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 验证数据持久化</h2>
        <button onclick="verifyPersistence()">验证持久化</button>
        <div id="persistenceStatus" class="test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 清理测试数据</h2>
        <button onclick="clearTestData()">清理测试数据</button>
        <div id="clearStatus" class="test-result"></div>
    </div>

    <script>
        // 模拟localStorage操作
        let mockLocalStorage = {};
        
        // 模拟localStorage.getItem
        function mockGetItem(key) {
            return mockLocalStorage[key] || null;
        }
        
        // 模拟localStorage.setItem
        function mockSetItem(key, value) {
            mockLocalStorage[key] = value;
            console.log(`localStorage.setItem('${key}', '${value}')`);
        }
        
        // 模拟localStorage.removeItem
        function mockRemoveItem(key) {
            delete mockLocalStorage[key];
            console.log(`localStorage.removeItem('${key}')`);
        }
        
        // 检查localStorage状态
        function checkLocalStorage() {
            const status = document.getElementById('localStorageStatus');
            const keys = Object.keys(mockLocalStorage);
            
            if (keys.length === 0) {
                status.innerHTML = '<div class="error">localStorage为空</div>';
            } else {
                let html = '<div class="success">localStorage内容:</div>';
                keys.forEach(key => {
                    const value = mockLocalStorage[key];
                    html += `<div><strong>${key}:</strong> ${value}</div>`;
                });
                status.innerHTML = html;
            }
        }
        
        // 模拟用户登录
        function simulateLogin() {
            const user = { username: 'test', password: '123', createdAt: new Date().toISOString() };
            mockSetItem('currentUser', JSON.stringify(user));
            
            // 初始化用户数据
            const allTopics = JSON.parse(mockGetItem('topics') || '{}');
            allTopics[user.username] = [];
            mockSetItem('topics', JSON.stringify(allTopics));
            
            document.getElementById('loginStatus').innerHTML = 
                '<div class="success">用户test登录成功，数据已初始化</div>';
        }
        
        function simulateLogin2() {
            const user = { username: 'test2', password: '456', createdAt: new Date().toISOString() };
            mockSetItem('currentUser', JSON.stringify(user));
            
            // 初始化用户数据
            const allTopics = JSON.parse(mockGetItem('topics') || '{}');
            allTopics[user.username] = [];
            mockSetItem('topics', JSON.stringify(allTopics));
            
            document.getElementById('loginStatus').innerHTML = 
                '<div class="success">用户test2登录成功，数据已初始化</div>';
        }
        
        // 添加测试数据
        function addTestData() {
            const currentUser = JSON.parse(mockGetItem('currentUser'));
            if (!currentUser) {
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="error">请先登录用户</div>';
                return;
            }
            
            const allTopics = JSON.parse(mockGetItem('topics') || '{}');
            const userTopics = allTopics[currentUser.username] || [];
            
            // 添加测试专题
            const newTopic = {
                id: Date.now().toString(),
                name: '测试专题',
                description: '这是一个测试专题',
                createdAt: new Date().toISOString(),
                tasks: []
            };
            
            userTopics.push(newTopic);
            allTopics[currentUser.username] = userTopics;
            mockSetItem('topics', JSON.stringify(allTopics));
            
            document.getElementById('dataOperationStatus').innerHTML = 
                '<div class="success">测试专题添加成功</div>';
        }
        
        // 修改测试数据
        function modifyTestData() {
            const currentUser = JSON.parse(mockGetItem('currentUser'));
            if (!currentUser) {
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="error">请先登录用户</div>';
                return;
            }
            
            const allTopics = JSON.parse(mockGetItem('topics') || '{}');
            const userTopics = allTopics[currentUser.username] || [];
            
            if (userTopics.length > 0) {
                userTopics[0].name = '修改后的测试专题';
                allTopics[currentUser.username] = userTopics;
                mockSetItem('topics', JSON.stringify(allTopics));
                
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="success">测试专题修改成功</div>';
            } else {
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="error">没有数据可修改</div>';
            }
        }
        
        // 删除测试数据
        function deleteTestData() {
            const currentUser = JSON.parse(mockGetItem('currentUser'));
            if (!currentUser) {
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="error">请先登录用户</div>';
                return;
            }
            
            const allTopics = JSON.parse(mockGetItem('topics') || '{}');
            const userTopics = allTopics[currentUser.username] || [];
            
            if (userTopics.length > 0) {
                userTopics.pop();
                allTopics[currentUser.username] = userTopics;
                mockSetItem('topics', JSON.stringify(allTopics));
                
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="success">测试专题删除成功</div>';
            } else {
                document.getElementById('dataOperationStatus').innerHTML = 
                    '<div class="error">没有数据可删除</div>';
            }
        }
        
        // 验证数据持久化
        function verifyPersistence() {
            const currentUser = JSON.parse(mockGetItem('currentUser'));
            if (!currentUser) {
                document.getElementById('persistenceStatus').innerHTML = 
                    '<div class="error">请先登录用户</div>';
                return;
            }
            
            const allTopics = JSON.parse(mockGetItem('topics') || '{}');
            const userTopics = allTopics[currentUser.username] || [];
            
            if (userTopics.length > 0) {
                document.getElementById('persistenceStatus').innerHTML = 
                    '<div class="success">数据持久化验证成功！用户数据已保存</div>';
            } else {
                document.getElementById('persistenceStatus').innerHTML = 
                    '<div class="error">数据持久化失败！用户数据未保存</div>';
            }
        }
        
        // 清理测试数据
        function clearTestData() {
            mockLocalStorage = {};
            document.getElementById('clearStatus').innerHTML = 
                '<div class="success">测试数据已清理</div>';
        }
        
        // 页面加载时检查状态
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html> 